{% extends "base.html" %}

{% block content %}
{% csrf_token %}

<div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
    <h1 class="h2">Gestión de Bastidores (Etapa: Ovas)</h1>
    <a href="{% url 'bastidor-create' %}" class="btn btn-primary"><i class="bi bi-plus-circle me-2"></i>Añadir Bastidor</a>
</div>

<div class="list-group">
    {% for unidad in unidades %}
        <div class="list-group-item d-flex justify-content-between align-items-center">
            <button type="button" class="btn btn-link text-start text-decoration-none text-dark flex-grow-1 p-0 border-0"
                    data-bs-toggle="modal" data-bs-target="#detailModal" 
                    data-unidad-id="{{ unidad.pk }}" 
                    data-tipo-unidad="bastidor">
                
                <div class="d-flex w-100">
                    <div class="flex-grow-1">
                        <h5 class="mb-1">{{ unidad.codigo }}</h5>
                        {% if not unidad.lote_actual %}
                            <small class="text-muted">Capacidad: {{ unidad.capacidad_maxima_unidades }} ovas</small>
                        {% endif %}
                    </div>
                    <div class="text-end">
                        {% if unidad.lote_actual %}
                            <h5 class="mb-1">{{ unidad.lote_actual.codigo_lote }}</h5>
                            <small class="text-muted">
                                <strong>{{ unidad.lote_actual.cantidad_total_peces }} / {{ unidad.capacidad_maxima_unidades }}</strong> ovas
                            </small>
                        {% endif %}
                    </div>
                </div>
            </button>
            
            <div class="d-flex align-items-center">
                {% if unidad.esta_disponible %}<span class="badge bg-secondary rounded-pill ms-3">Disponible</span>{% else %}<span class="badge bg-success rounded-pill ms-3">Ocupado</span>{% endif %}
                <div class="btn-group ms-2" role="group">
                    <a href="{% url 'bastidor-update' unidad.pk %}" class="btn btn-sm btn-outline-primary" title="Editar"><i class="bi bi-pencil-fill"></i></a>
                    <button type="button" class="btn btn-sm btn-outline-danger" title="Eliminar" data-bs-toggle="modal" data-bs-target="#confirmDeleteModal" data-form-url="{% url 'bastidor-delete' unidad.pk %}"><i class="bi bi-trash-fill"></i></button>
                </div>
            </div>
        </div>
    {% empty %}
        <p class="text-center text-muted mt-4">No hay bastidores registrados.</p>
    {% endfor %}
</div>

<div class="modal fade" id="detailModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="detailModalTitle">Detalle</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="detailModalBody"></div></div></div></div>

{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const detailModalEl = document.getElementById('detailModal');
    if (!detailModalEl) return;
    const detailModal = new bootstrap.Modal(detailModalEl);
    
    // Se comentan los modals que no se van a usar
    // const addLoteModal = new bootstrap.Modal(document.getElementById('addLoteModal'));
    // const moveLoteModal = new bootstrap.Modal(document.getElementById('moveLoteModal'));
    // const createArtesaModal = new bootstrap.Modal(document.getElementById('createArtesaModal'));
    
    const csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]').value;

    detailModalEl.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        if (!button || !button.hasAttribute('data-unidad-id')) return;
        const unidadId = button.getAttribute('data-unidad-id');
        const tipoUnidad = 'bastidor';
        const modalTitle = detailModalEl.querySelector('.modal-title');
        const modalBody = detailModalEl.querySelector('.modal-body');
        modalTitle.textContent = `Detalle de Bastidor`;
        modalBody.innerHTML = '<div class="text-center p-3"><div class="spinner-border spinner-border-sm" role="status"></div> Cargando...</div>';
        fetch(`/produccion/api/unidad/${tipoUnidad}/${unidadId}/`, { cache: 'reload' })
            .then(response => { if (!response.ok) throw new Error(`Error: ${response.statusText}`); return response.json(); })
            .then(data => {
                let content = '';
                if (data.lote) {
                    const dias = data.lote.dias_en_etapa;
                    const moverDisabled = dias < 15 ? 'disabled' : '';
                    const limpiezaClass = data.lote.limpieza_hoy ? 'btn-success' : 'btn-outline-secondary';
                    const moverClass = dias >= 15 ? 'btn-primary' : 'btn-outline-secondary';
                    
                    // Se mantiene la información del lote y el formulario de bajas
                    content = `<div class="d-flex justify-content-between align-items-center"><h5 class="mb-0">Lote Actual: ${data.lote.codigo}</h5><span class="badge bg-info-subtle text-info-emphasis rounded-pill">Días en etapa: ${dias}</span></div><hr class="my-3"><ul class="list-group list-group-flush mb-3"><li class="list-group-item d-flex justify-content-between align-items-center ps-0"><span><i class="bi bi-box-seam me-2 text-muted"></i>Cantidad Total</span><strong id="loteCantidad">${data.lote.cantidad}</strong></li><li class="list-group-item d-flex justify-content-between align-items-center ps-0"><span><i class="bi bi-bounding-box-circles me-2 text-muted"></i>Capacidad Máxima</span><strong>${data.unidad.capacidad}</strong></li></ul><form id="mortalidadForm" data-lote-id="${data.lote.id}" autocomplete="off" class="mb-3"><label class="form-label small">Registrar Bajas</label><div class="input-group"><span class="input-group-text"><i class="bi bi-heartbreak-fill"></i></span><input type="number" name="cantidad" class="form-control" placeholder="N° de muertos" required min="1"><button type="submit" class="btn btn-danger">Registrar</button></div><div id="mortalidadErrors" class="small mt-1"></div></form>`;
                    
                    // Se comenta la sección de ACCIONES
                    /*
                    content += `<div class="mt-4 text-center"><h6 class="text-muted small text-uppercase">Acciones Diarias</h6><div class="d-flex justify-content-center gap-3 mt-3"><div><button class="btn ${limpiezaClass} rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;" data-tarea="limpieza" data-lote-id="${data.lote.id}" title="Limpiar"><i class="bi bi-snow fs-5"></i></button><div class="small mt-1">Limpiar</div></div><div><button class="btn ${moverClass} rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;" id="openMoveLoteBtn" data-lote-id="${data.lote.id}" ${moverDisabled} title="Mover Lote (habilitado a los 15 días)"><i class="bi bi-arrows-move fs-5"></i></button><div class="small mt-1">Mover</div></div></div></div>`;
                    */
                } else {
                    content = `<div class="text-center p-3"><p class="lead">Esta unidad está disponible.</p>`;
                    // Se comenta el botón para añadir ovas
                    // content += `<button class="btn btn-success btn-lg" id="openAddLoteBtn" data-bastidor-id="${data.unidad.id}" data-bastidor-codigo="${data.unidad.codigo}" data-bastidor-capacidad="${data.unidad.capacidad}"><i class="bi bi-plus-circle me-2"></i>Añadir Ovas</button>`;
                    content += `</div>`;
                }
                modalBody.innerHTML = content;
            })
            .catch(error => { modalBody.innerHTML = `<p class="text-danger">Error al cargar los detalles.</p>`; console.error('Error:', error); });
    });
    
    // Se comenta la función que busca artesas, ya que no se va a usar
    /*
    function fetchAndDisplayArtesas(loteId) {
        const moveBody = document.getElementById('moveLoteBody');
        moveBody.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div></div>';
        fetch(`/produccion/api/artesas_disponibles/${loteId}/`)
            .then(response => response.json())
            .then(artesas => {
                let listHTML = '';
                if (artesas.length > 0) {
                    listHTML = '<p>Selecciona una artesa de destino:</p><div class="list-group">';
                    artesas.forEach(artesa => { listHTML += `<button type="button" class="list-group-item list-group-item-action move-lote-target" data-artesa-id="${artesa.id}" data-lote-id="${loteId}"><strong>${artesa.codigo}</strong> - Capacidad: ${artesa.capacidad_maxima_unidades}</button>`; });
                    listHTML += '</div>';
                } else {
                    listHTML = '<div class="alert alert-warning">No hay artesas disponibles. <button type="button" id="openCreateArtesaBtn" class="btn btn-sm btn-success ms-2">Añadir una nueva</button></div>';
                }
                moveBody.innerHTML = listHTML;
            });
    }
    */

    document.body.addEventListener('click', function(event) {
        // La lógica para marcar tareas se mantiene por si se activa en el futuro
        const tareaButton = event.target.closest('[data-tarea]');
        if (tareaButton) {
            const loteId = tareaButton.dataset.loteId;
            const tarea = tareaButton.dataset.tarea;
            fetch(`/produccion/api/lote/${loteId}/marcar_tarea/${tarea}/`, { method: 'POST', headers: {'X-CSRFToken': csrfToken} })
            .then(response => response.json())
            .then(data => { if (data.success) { tareaButton.classList.remove('btn-outline-secondary'); tareaButton.classList.add('btn-success'); tareaButton.blur(); }});
        }
        
        // Se comentan los manejadores de click de las funciones avanzadas
        /*
        if (event.target.id === 'openMoveLoteBtn') {
            const loteId = event.target.dataset.loteId;
            detailModal.hide();
            moveLoteModal.show();
            fetchAndDisplayArtesas(loteId);
        }
        const moveTargetButton = event.target.closest('.move-lote-target');
        if (moveTargetButton) {
            const loteId = moveTargetButton.dataset.loteId;
            const artesaId = moveTargetButton.dataset.artesaId;
            if (confirm('¿Estás seguro de que quieres mover este lote a la artesa seleccionada?')) {
                fetch(`/produccion/api/lote/${loteId}/mover_a_artesa/${artesaId}/`, { method: 'POST', headers: {'X-CSRFToken': csrfToken} })
                .then(response => response.json())
                .then(data => { if (data.success) { alert(data.message); window.location.reload(); } else { alert('Error: ' + data.error); }});
            }
        }
        if (event.target.id === 'openCreateArtesaBtn') {
            document.getElementById('createArtesaForm').reset();
            moveLoteModal.hide();
            createArtesaModal.show();
        }
        if (event.target.id === 'openAddLoteBtn') {
            const button = event.target;
            document.getElementById('addLoteBastidorCodigo').textContent = button.getAttribute('data-bastidor-codigo');
            document.getElementById('addLoteCapacidad').textContent = button.getAttribute('data-bastidor-capacidad');
            const addLoteForm = document.getElementById('addLoteForm');
            let hiddenInput = addLoteForm.querySelector('input[name="bastidor_id"]');
            if (!hiddenInput) {
                hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'bastidor_id';
                addLoteForm.appendChild(hiddenInput);
            }
            hiddenInput.value = button.getAttribute('data-bastidor-id');
            document.getElementById('addLoteErrors').innerHTML = '';
            addLoteForm.reset();
            detailModal.hide();
            addLoteModal.show();
        }
        */
    });
    
    // Se comentan los event listeners de los formularios avanzados
    /*
    document.getElementById('createArtesaForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        const errorDiv = document.getElementById('createArtesaErrors');
        const loteId = document.querySelector('#openMoveLoteBtn, .move-lote-target')?.dataset.loteId;
        fetch('{% url "artesa-create" %}', { method: 'POST', body: formData, headers: {'X-CSRFToken': csrfToken} })
            .then(response => {
                if (response.ok) { createArtesaModal.hide(); moveLoteModal.show(); fetchAndDisplayArtesas(loteId); }
                else { errorDiv.textContent = 'Error al crear la artesa.'; }
            });
    });

    document.getElementById('addLoteForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const formData = new FormData(this);
        const bastidorIdInput = this.querySelector('input[name="bastidor_id"]');
        if (!bastidorIdInput) return;
        const bastidorId = bastidorIdInput.value;
        const errorDiv = document.getElementById('addLoteErrors');
        fetch(`/produccion/api/lote/ova/crear/${bastidorId}/`, { method: 'POST', body: formData, headers: {'X-CSRFToken': csrfToken} })
            .then(response => response.json())
            .then(data => { if (data.success) { window.location.reload(); } else { errorDiv.textContent = data.error || 'Ocurrió un error.'; }})
            .catch(error => { errorDiv.textContent = 'Error de conexión.'; });
    });
    */

    // Se mantiene el listener para el formulario de registrar bajas
    document.body.addEventListener('submit', function(event) {
        if (event.target && event.target.id === 'mortalidadForm') {
            event.preventDefault();
            const form = event.target;
            const loteId = form.getAttribute('data-lote-id');
            const errorDiv = form.querySelector('#mortalidadErrors');
            const cantidadSpan = document.getElementById('loteCantidad');
            const formData = new FormData(form);
            fetch(`/produccion/api/lote/${loteId}/registrar_mortalidad/`, { method: 'POST', body: formData, headers: {'X-CSRFToken': csrfToken} })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        cantidadSpan.textContent = data.nueva_cantidad;
                        form.reset();
                        errorDiv.innerHTML = '<span class="text-success small">Bajas registradas.</span>';
                        // Para no recargar toda la página, actualizamos el dato en la lista principal también
                        const mainListItem = document.querySelector(`button[data-unidad-id="${data.unidad_id}"]`);
                        if(mainListItem){
                            mainListItem.querySelector('strong').textContent = `${data.nueva_cantidad} / ${data.capacidad}`;
                        }
                    } else {
                        errorDiv.innerHTML = `<span class="text-danger small">${data.error || 'Ocurrió un error.'}</span>`;
                    }
                })
                .catch(error => { errorDiv.textContent = 'Error de conexión.'; });
        }
    });
});
</script>
{% endblock scripts %}